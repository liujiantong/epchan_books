clear;

load('C:/Projects/reversal_data/inputData_SPX_200401_201312', 'syms', 'tday', 'bid', 'ask');

[num txt]=xlsread('C:/Projects/Compustat/AnnualFundamentalsSPX/Annual2.csv');
tickers=txt(2:end, strcmp('tic', txt(1, :)));
gind=num(:, strcmp('gind', txt(1, :))); % 65 GIC industry groups
fiscalYr=num(:, strcmp('fyear', txt(1, :)));

% Pick the first industry group as example, and pick those stocks whos
% industry group has not changed
myTickers=unique(tickers(gind==gind(1))); % gind(1) is "Electric Utilities"

% for s=1:length(myTickers)
%    if (length(unique(gind(strcmp(tickers, myTickers(1))))) > 1)
%        myTickers(s)='';
%    end
%     
% end

[~, idx1, idx2]=intersect(syms, myTickers);

% intersect(syms, myTickers)'
% 
% ans = 
% 
%     'AEP'    'DUK'    'EIX'    'ETR'    'EXC'    'FE'    'NEE'    'NU'    'PNW'    'POM'    'PPL'    'SO'    'XEL'


bid=fillMissingData(bid);
ask=fillMissingData(ask);
mid=(bid(:, idx1)+ask(:, idx1))/2;

incompleteDataIdx=find(sum(isnan(mid), 1) > 0);
mid(:, incompleteDataIdx)=[];

trainset=1:(length(mid)-252); % Use all but 1 year of bars for in-sample fitting

pMin=1;
model=vgxset('n', size(mid, 2), 'nAR', pMin, 'Constant', true); % with additive offset

[model, estStdErrors]=vgxvarx(model,mid(trainset, :));

vgxdisp(model, estStdErrors);
%   Model  : 11-D VAR(1) with Additive Constant
%            Conditional mean is AR-stable and is MA-invertible
%            Standard errors without DoF adjustment (maximum likelihood)
%        Parameter          Value     Std. Error    t-Statistic
%   -------------- -------------- -------------- --------------
%             a(1)        4.46982       0.312661        14.2961 
%             a(2)        5.70775       0.399753        14.2782 
%             a(3)        5.22861       0.374208        13.9725 
%             a(4)        10.7321        0.71432        15.0242 
%             a(5)        6.92013        0.50353        13.7432 
%             a(6)        6.10562       0.460294        13.2646 
%             a(7)         6.4703       0.455974        14.1901 
%             a(8)        4.98328        0.34746         14.342 
%             a(9)        4.11453       0.283325        14.5223 
%            a(10)          3.776       0.260166        14.5138 
%            a(11)         2.5142       0.168783         14.896 
%       AR(1)(1,1)        1.01993      0.0256644         39.741 
%            (1,2)      0.0776958      0.0249548        3.11346 
%            (1,3)      0.0814803      0.0139052         5.8597 
%            (1,4)     -0.0419979     0.00731467        -5.7416 
%            (1,5)     -0.0114567      0.0131112      -0.873812 
%            (1,6)     0.00969255     0.00964017        1.00543 
%            (1,7)     0.00980228     0.00899252        1.09005 
%            (1,8)     -0.0158283       0.023933      -0.661359 
%            (1,9)     -0.0754635      0.0225519       -3.34622 
%           (1,10)     -0.0601903      0.0209173       -2.87754 
%           (1,11)      -0.236597      0.0591042       -4.00305 
%            (2,1)      0.0573716      0.0328133        1.74843 
%            (2,2)        1.05454      0.0319059        33.0514 
%            (2,3)       0.103376      0.0177785        5.81469 
%            (2,4)     -0.0570182     0.00935217       -6.09679 
%            (2,5)      -0.019441      0.0167633       -1.15974 
%            (2,6)      0.0154689      0.0123254        1.25504 
%            (2,7)     0.00995044      0.0114974       0.865453 
%            (2,8)     -0.0388597      0.0305995       -1.26994 
%            (2,9)     -0.0903114      0.0288337       -3.13214 
%           (2,10)      -0.054811      0.0267438       -2.04948 
%           (2,11)      -0.237041      0.0755677        -3.1368 
%            (3,1)      0.0765287      0.0307165        2.49146 
%            (3,2)      0.0981686      0.0298671        3.28685 
%            (3,3)        1.07867      0.0166424        64.8144 
%            (3,4)     -0.0517997     0.00875456       -5.91689 
%            (3,5)     -0.0145309      0.0156921      -0.926001 
%            (3,6)      0.0121495      0.0115378        1.05301 
%            (3,7)      0.0132272      0.0107627        1.22899 
%            (3,8)     -0.0469833      0.0286441       -1.64024 
%            (3,9)     -0.0952695      0.0269912       -3.52965 
%           (3,10)     -0.0824416      0.0250348       -3.29307 
%           (3,11)      -0.265042      0.0707388       -3.74677 
%            (4,1)       0.170161      0.0586342        2.90208 
%            (4,2)       0.206984      0.0570129        3.63048 
%            (4,3)       0.171221      0.0317685        5.38965 
%            (4,4)       0.881337      0.0167114        52.7385 
%            (4,5)     -0.0300136      0.0299544       -1.00198 
%            (4,6)      0.0309748      0.0220244        1.40639 
%            (4,7)      0.0194829      0.0205447       0.948315 
%            (4,8)      -0.138103      0.0546784       -2.52573 
%            (4,9)      -0.184349      0.0515231       -3.57798 
%           (4,10)      -0.193336      0.0477886       -4.04565 
%           (4,11)      -0.449145       0.135032        -3.3262 
%            (5,1)      0.0852749      0.0413318        2.06318 
%            (5,2)       0.106243      0.0401889         2.6436 
%            (5,3)       0.127414      0.0223939         5.6897 
%            (5,4)     -0.0575941        0.01178       -4.88913 
%            (5,5)       0.949381      0.0211151        44.9622 
%            (5,6)      0.0259997      0.0155252        1.67468 
%            (5,7)     0.00450487      0.0144822       0.311063 
%            (5,8)     -0.0833794      0.0385433       -2.16327 
%            (5,9)      -0.104548      0.0363191       -2.87858 
%           (5,10)      -0.100612      0.0336866       -2.98672 
%           (5,11)      -0.276761      0.0951855       -2.90759 
%            (6,1)      0.0660215      0.0377828         1.7474 
%            (6,2)       0.136289       0.036738        3.70975 
%            (6,3)       0.112956       0.020471        5.51784 
%            (6,4)      -0.065279      0.0107685       -6.06201 
%            (6,5)      0.0060806       0.019302       0.315024 
%            (6,6)       0.992719      0.0141921        69.9487 
%            (6,7)      0.0215639      0.0132386        1.62887 
%            (6,8)     -0.0458886      0.0352337       -1.30241 
%            (6,9)      -0.127319      0.0332005       -3.83486 
%           (6,10)      -0.089227      0.0307941       -2.89754 
%           (6,11)      -0.371245      0.0870122       -4.26659 
%            (7,1)      0.0525239      0.0374282        1.40333 
%            (7,2)      0.0965515      0.0363932        2.65301 
%            (7,3)       0.126726      0.0202789        6.24919 
%            (7,4)     -0.0600017      0.0106675       -5.62474 
%            (7,5)     -0.0228065      0.0191209       -1.19275 
%            (7,6)      0.0122695      0.0140589       0.872724 
%            (7,7)        1.00233      0.0131144        76.4302 
%            (7,8)     -0.0508806       0.034903       -1.45777 
%            (7,9)      -0.107113      0.0328889        -3.2568 
%           (7,10)     -0.0700114      0.0305051       -2.29508 
%           (7,11)      -0.296448      0.0861956       -3.43924 
%            (8,1)      0.0690177      0.0285209         2.4199 
%            (8,2)      0.0882688      0.0277323        3.18289 
%            (8,3)      0.0894243      0.0154529        5.78691 
%            (8,4)     -0.0459992      0.0081288       -5.65879 
%            (8,5)     -0.0226535      0.0145704       -1.55476 
%            (8,6)      0.0116298      0.0107131        1.08557 
%            (8,7)     0.00978538     0.00999339       0.979185 
%            (8,8)       0.926872      0.0265967        34.8491 
%            (8,9)     -0.0921669      0.0250619       -3.67756 
%           (8,10)     -0.0579782      0.0232454       -2.49418 
%           (8,11)      -0.227562      0.0656826       -3.46457 
%            (9,1)      0.0718266      0.0232565        3.08846 
%            (9,2)      0.0845109      0.0226134        3.73721 
%            (9,3)      0.0773313      0.0126005        6.13714 
%            (9,4)     -0.0411652     0.00662837       -6.21045 
%            (9,5)    -0.00310466       0.011881      -0.261313 
%            (9,6)     0.00733036     0.00873568       0.839129 
%            (9,7)       0.018428     0.00814879        2.26144 
%            (9,8)     -0.0567528      0.0216874       -2.61685 
%            (9,9)       0.887605       0.020436        43.4335 
%           (9,10)     -0.0660457      0.0189547       -3.48439 
%           (9,11)      -0.217265      0.0535588       -4.05658 
%           (10,1)      0.0375125      0.0213555        1.75657 
%           (10,2)      0.0633068       0.020765        3.04873 
%           (10,3)      0.0669144      0.0115706        5.78316 
%           (10,4)     -0.0365881     0.00608656        -6.0113 
%           (10,5)     -0.0146326      0.0109098       -1.34123 
%           (10,6)      0.0113674     0.00802162         1.4171 
%           (10,7)     0.00318907     0.00748271       0.426192 
%           (10,8)     -0.0372053      0.0199147       -1.86823 
%           (10,9)      -0.060569      0.0187655       -3.22768 
%           (10,10)       0.944485      0.0174053        54.2641 
%           (10,11)      -0.158027      0.0491808       -3.21319 
%           (11,1)      0.0305341      0.0138544        2.20393 
%           (11,2)      0.0521917      0.0134713        3.87428 
%           (11,3)      0.0406519     0.00750642        5.41561 
%           (11,4)     -0.0241138     0.00394867       -6.10682 
%           (11,5)    -0.00368165     0.00707778      -0.520171 
%           (11,6)     0.00254247     0.00520404       0.488556 
%           (11,7)     0.00785522     0.00485442        1.61816 
%           (11,8)     -0.0189269      0.0129197       -1.46496 
%           (11,9)     -0.0503766      0.0121742       -4.13799 
%           (11,10)     -0.0263377      0.0112918       -2.33247 
%           (11,11)       0.837082      0.0319062        26.2358 
%           Q(1,1)       0.733923                               
%           Q(2,1)       0.877551                               
%           Q(2,2)        1.19974                               
%           Q(3,1)       0.814212                               
%           Q(3,2)        1.02954                               
%           Q(3,3)        1.05131                               
%           Q(4,1)         1.5423                               
%           Q(4,2)        1.93178                               
%           Q(4,3)        1.85175                               
%           Q(4,4)         3.8308                               
%           Q(5,1)         1.0534                               
%           Q(5,2)        1.30476                               
%           Q(5,3)         1.2806                               
%           Q(5,4)        2.46165                               
%           Q(5,5)        1.90351                               
%           Q(6,1)       0.990048                               
%           Q(6,2)        1.24597                               
%           Q(6,3)        1.18756                               
%           Q(6,4)        2.26345                               
%           Q(6,5)        1.57737                               
%           Q(6,6)        1.59065                               
%           Q(7,1)       0.976972                               
%           Q(7,2)        1.23856                               
%           Q(7,3)        1.16821                               
%           Q(7,4)        2.22585                               
%           Q(7,5)        1.52984                               
%           Q(7,6)        1.42869                               
%           Q(7,7)        1.56093                               
%           Q(8,1)       0.761395                               
%           Q(8,2)        0.98243                               
%           Q(8,3)       0.893781                               
%           Q(8,4)        1.68135                               
%           Q(8,5)        1.13621                               
%           Q(8,6)        1.08106                               
%           Q(8,7)        1.06698                               
%           Q(8,8)       0.906388                               
%           Q(9,1)       0.598632                               
%           Q(9,2)       0.749924                               
%           Q(9,3)       0.724689                               
%           Q(9,4)        1.37107                               
%           Q(9,5)        0.96354                               
%           Q(9,6)       0.876776                               
%           Q(9,7)       0.870249                               
%           Q(9,8)       0.648775                               
%           Q(9,9)       0.602663                               
%          Q(10,1)       0.570424                               
%          Q(10,2)       0.740702                               
%          Q(10,3)       0.668704                               
%          Q(10,4)        1.26437                               
%          Q(10,5)       0.854485                               
%          Q(10,6)       0.810026                               
%          Q(10,7)       0.803559                               
%          Q(10,8)       0.638883                               
%          Q(10,9)       0.489494                               
%         Q(10,10)       0.508166                               
%          Q(11,1)       0.370785                               
%          Q(11,2)        0.47839                               
%          Q(11,3)       0.440102                               
%          Q(11,4)       0.823192                               
%          Q(11,5)       0.554029                               
%          Q(11,6)        0.52835                               
%          Q(11,7)       0.524109                               
%          Q(11,8)       0.418621                               
%          Q(11,9)       0.318564                               
%         Q(11,10)       0.312365                               
%         Q(11,11)       0.213876    

testset=trainset(end)+1:size(mid, 1);

yF=NaN(size(mid));

for t=testset(1):size(mid, 1)
    FY = vgxpred(model,1, [], mid(t-pMin+1:t, :));
    yF(t, :)=FY;
end

retF=(yF-mid)./mid;

pos=zeros(size(retF));
pos=retF./repmat(smartsum(abs(retF), 2), [1, size(retF, 2)]);

ret=smartsum(backshift(1, pos).*(mid-backshift(1, mid))./backshift(1, mid), 2);
ret(isnan(ret))=0;
cumret=cumprod(1+ret)-1;

plot(datetime(tday(testset), 'ConvertFrom', 'yyyyMMdd'), cumret(testset));
title('VAR(1) model on electric utilities SPX stocks');
xlabel('Date');
ylabel('Cumulative Returns');



% Test set cumulative return
(1+cumret(end))/(1+cumret(trainset(end)))-1
%    0.304255691496083

% Annualized compound returns on testset
((1+cumret(end))/(1+cumret(trainset(end))))^(252/length(testset))-1
%    0.304255691496083

